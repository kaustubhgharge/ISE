<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Bin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 400px; }
    .status-full { background-color: #ffcccc; }
    .status-nearly_full { background-color: #fff0b3; }
    .status-inactive { background-color: #cce5ff; }
    .status-ok { background-color: #ccffcc; }
  </style>
</head>
<body class="container py-4">
  <h2>üóë Smart Bin Dashboard</h2>

  <div class="row mb-3">
    <div class="col">
      <label>Full Threshold</label>
      <input type="range" id="full-threshold" min="0" max="100" value="80" class="form-range">
      <div><strong>Full:</strong> <span id="full-val">80%</span></div>
    </div>
    <div class="col">
      <label>Nearly Full Threshold</label>
      <input type="range" id="nearly-threshold" min="0" max="100" value="60" class="form-range">
      <div><strong>Nearly Full:</strong> <span id="nearly-val">60%</span></div>
    </div>
    <div class="col">
      <label>Inactive (days)</label>
      <input type="range" id="inactive-threshold" min="0" max="30" value="5" class="form-range">
      <div><strong>Inactive after:</strong> <span id="inactive-val">5</span> days</div>
    </div>
  </div>

  <button class="btn btn-secondary" onclick="reloadBins()">üîÑ Reload Bins</button>
  <button class="btn btn-success" onclick="showRoute()">üìç Optimized Route</button>

  <select id="bin-select" multiple class="form-select w-25 d-inline-block my-2"></select>
  <button class="btn btn-warning" onclick="simulateReport()">‚úÖ Simulate Report</button>

  <div id="map" class="my-3"></div>
  <div id="bin-cards" class="row"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map("map").setView([52.03, 8.89], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    let markers = [], routeLine;

    function getThresholds() {
      return {
        full: +document.getElementById("full-threshold").value,
        nearly_full: +document.getElementById("nearly-threshold").value,
        inactive: +document.getElementById("inactive-threshold").value
      };
    }

    function updateThresholdLabels() {
      document.getElementById("full-val").textContent = document.getElementById("full-threshold").value + "%";
      document.getElementById("nearly-val").textContent = document.getElementById("nearly-threshold").value + "%";
      document.getElementById("inactive-val").textContent = document.getElementById("inactive-threshold").value;
    }

    ["full-threshold", "nearly-threshold", "inactive-threshold"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        updateThresholdLabels();
        loadBins();
      });
    });

    function loadBins() {
      const t = getThresholds();
      fetch(`/api/bins?full=${t.full}&nearly_full=${t.nearly_full}&inactive=${t.inactive}`)
        .then(res => res.json())
        .then(bins => {
          updateMapAndUI(bins);
        });
    }

    function reloadBins() {
      fetch("/api/reload", { method: "POST" })
        .then(() => loadBins());
    }

    function simulateReport() {
      const selected = Array.from(document.getElementById("bin-select").selectedOptions).map(opt => +opt.value);
      fetch("/api/collect", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bin_ids: selected })
      }).then(() => loadBins());
    }

    function showRoute() {
      fetch("/api/optimized_route")
        .then(res => res.json())
        .then(data => {
          if (routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline(data.path, { color: 'red' }).addTo(map);
          map.fitBounds(routeLine.getBounds());
        });
    }

    function updateMapAndUI(bins) {
      const binSelect = document.getElementById("bin-select");
      const binCards = document.getElementById("bin-cards");
      binSelect.innerHTML = "";
      binCards.innerHTML = "";
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      bins.forEach(bin => {
        // Add to select dropdown
        let option = document.createElement("option");
        option.value = bin.id;
        option.text = `Bin ${bin.id} (${bin.status})`;
        binSelect.appendChild(option);

        // Add to map
        const color = bin.status === "full" ? "red" :
                      bin.status === "nearly_full" ? "orange" :
                      bin.status === "inactive" ? "blue" : "green";
        const marker = L.circleMarker([bin.lat, bin.lon], {
          radius: 8,
          fillColor: color,
          color: color,
          fillOpacity: 0.7
        }).bindPopup(`Bin ${bin.id}<br>Type: ${bin.type}<br>Fill: ${bin.fill}%`).addTo(map);
        markers.push(marker);

        // Add card
        binCards.innerHTML += `
          <div class="col-md-4">
            <div class="card mb-3 status-${bin.status}">
              <div class="card-body">
                <h5>Bin ${bin.id}</h5>
                <p>Type: ${bin.type}</p>
                <p>Location: ${bin.location}</p>
                <p>Fill: ${bin.fill}%</p>
                <p>Last emptied: ${bin.last_emptied_days_ago} days ago</p>
                <p>Status: <strong>${bin.status}</strong></p>
              </div>
            </div>
          </div>`;
      });
    }

    updateThresholdLabels();
    loadBins();
  </script>
</body>
</html>
